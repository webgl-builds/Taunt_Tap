<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Unity WebGL Player | Taunt_Build_1</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  <link rel="manifest" href="manifest.webmanifest" />
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
  </div>

  <script>
    var unityInstance = null;

    const build2URL = "https://webgl-builds.github.io/SpearOnNear/";
    const build2UnityCacheKey = "Spear-Spear On Near-3.2";

    const contentToCache = [
      "Build/tt.loader.js",
      "Build/tt.framework.js.unityweb",
      "Build/tt.data.unityweb",
      "Build/tt.wasm.unityweb",
      "TemplateData/style.css",
    ];

    const build2Files = contentToCache.map((path) => build2URL + path);

    function safeSendMessage (goName, methodName, param) {
      if (typeof SendMessage === "function") {
        SendMessage(goName, methodName, param);
      }
    }

    function initBuild1 () {
      const container = document.querySelector("#unity-container");
      const canvas = document.querySelector("#unity-canvas");
      const loadingBar = document.querySelector("#unity-loading-bar");
      const progressBarFull = document.querySelector("#unity-progress-bar-full");

      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Taunt_Tap.loader.js";
      const config = {
        dataUrl: buildUrl + "/Taunt_Tap.data",
        frameworkUrl: buildUrl + "/Taunt_Tap.framework.js",
        codeUrl: buildUrl + "/Taunt_Tap.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Taunt_Build_1",
        productVersion: "0.1.1",
      };

      loadingBar.style.display = "block";

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        })
          .then((instance) => {
            unityInstance = instance;
            window.SendMessage = unityInstance.SendMessage;
            waitForUnityAndStart();
            loadingBar.style.display = "none";
          })
          .catch((message) => alert(message));
      };
      document.body.appendChild(script);
    }

    function waitForUnityAndStart () {
      const checkReady = setInterval(() => {
        if (typeof unityInstance !== "undefined" && unityInstance.Module && typeof SendMessage === "function") {
          console.log("‚úÖ Unity ready, starting build2 download.");
          downloadAndCacheBuild2();
          clearInterval(checkReady);
        }
      }, 500);
    }

    async function downloadAndCacheBuild2 () {
      const cache = await caches.open(build2UnityCacheKey);
      let completed = 0;

      for (let i = 0; i < build2Files.length; i++) {
        const url = build2Files[i];
        const path = contentToCache[i];

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error ${response.status}`);
          await cache.put(path, response.clone());
          completed++;
          const percent = Math.round((completed / build2Files.length) * 100);
          safeSendMessage("Code", "UpdateFill", percent.toString());
        } catch (err) {
          console.error(`‚ùå Error caching ${url}`, err);
        }
      }

      safeSendMessage("Code", "DownloadComplete", build2URL);
      console.log("‚úÖ Build2 cached.");
    }

    initBuild1();

    function dropAll () {
      caches.delete(build2UnityCacheKey).then((success) => {
        if (success) console.log(`üóëÔ∏è Cache "${build2UnityCacheKey}" deleted.`);
      });
    }
  </script>
</body>

</html>